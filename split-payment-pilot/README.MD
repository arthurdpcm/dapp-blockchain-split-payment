# ðŸ’µ Split Payment Smart Contract

Bem-vindo ao repositÃ³rio do Split Payment Smart Contract! Este projeto apresenta um contrato inteligente robusto para facilitar pagamentos divididos, com suporte para tokens ERC-20, integraÃ§Ã£o com Uniswap V3 para swaps e uma suÃ­te de testes completa rodando em um fork da mainnet da Polygon.

Este README vai te guiar desde a configuraÃ§Ã£o do ambiente atÃ© a implantaÃ§Ã£o, interaÃ§Ã£o e anÃ¡lise de seguranÃ§a do contrato.

# ðŸ‘€ VisÃ£o Geral do Contrato

O `SplitPayment` Ã© um contrato inteligente projetado para distribuir fundos de forma programÃ¡tica. As principais funcionalidades incluem:

- **DivisÃ£o de Pagamentos**: Permite que fundos (ETH/MATIC ou tokens ERC-20) sejam enviados para um destinatÃ¡rio principal, com uma porcentagem sendo retida como imposto para uma `taxWallet`.
- **Suporte a Stablecoins**: Permite ao dono do contrato registrar e desregistrar endereÃ§os de tokens que sÃ£o considerados stablecoins, facilitando a gestÃ£o de taxas e swaps.
- **IntegraÃ§Ã£o com Uniswap V3**: O contrato pode interagir com o router da Uniswap V3 para realizar swaps de tokens. Por exemplo, trocar um token recebido por uma stablecoin antes de repassar ao destinatÃ¡rio.
- **SeguranÃ§a**: FunÃ§Ãµes crÃ­ticas sÃ£o protegidas com o modificador `onlyOwner`.

# ðŸ› ï¸ Tecnologias Envolvidas

Este projeto utiliza um conjunto de ferramentas poderosas do ecossistema de desenvolvimento blockchain:

- **Hardhat**: Ambiente de desenvolvimento para compilar, implantar, testar e depurar contratos Solidity.
- **Foundry (Anvil)**: Um framework de desenvolvimento ultra-rÃ¡pido para Ethereum, usado aqui para forking local da mainnet da Polygon.
- **Ethers.js**: Biblioteca para interagir com a blockchain Ethereum/EVM usando JavaScript/TypeScript.
- **solidity-coverage**: Plugin do Hardhat para gerar relatÃ³rios de cobertura de cÃ³digo.
- **Mythril**: Ferramenta de anÃ¡lise de seguranÃ§a para detectar vulnerabilidades em contratos.
- **The Graph**: Utilizado nos testes para consultar dinamicamente dados de pools da Uniswap V3, como a `feeTier` correta.
- **dotenv**: Para gerenciar variÃ¡veis de ambiente de forma segura.

# 1. Primeiros Passos: ConfiguraÃ§Ã£o e InstalaÃ§Ã£o

Para comeÃ§ar a trabalhar com este projeto, siga os passos abaixo.

### PrÃ©-requisitos
- [Node.js](https://nodejs.org/en/) (versÃ£o 18.x ou superior)
- [Foundry](https://getfoundry.sh/)

### InstalaÃ§Ã£o

1.  **Clone o RepositÃ³rio:**
    ```bash
    git clone https://github.com/arthurdpcm/dapp-blockchain-split-payment.git
    cd dapp-blockchain-split-payment/split-payment-pilot
    ```

2.  **Instale as dependÃªncias do Node.js:**
    ```bash
    npm install
    ```

3.  **Instale o Foundry (se ainda nÃ£o tiver):**
    ```bash
    curl -L https://foundry.paradigm.xyz | bash
    foundryup # Garante que vocÃª tem a Ãºltima versÃ£o
    anvil --version
    ```

4.  **Renomeie o arquivo `.env.example` para `.env` na raiz da pasta `split-payment-pilot/` e defina as suas varÃ­aveis.**

# 2. Rodando um Fork Local da Polygon com Anvil

Para testar e interagir com o contrato em um ambiente realista, vamos usar o Anvil para criar um fork da mainnet da Polygon. Isso nos dÃ¡ acesso a todos os contratos e dados da mainnet (como tokens e pools da Uniswap) em um ambiente de desenvolvimento local e rÃ¡pido.

Abra um novo terminal e execute:
```bash
anvil --fork-url $POLYGON_MAINNET_RPC_URL
# Se vocÃª nÃ£o configurou a variÃ¡vel de ambiente no seu shell, pode passar a URL diretamente:
# anvil --fork-url https://polygon-rpc.com
```
Anvil iniciarÃ¡ um nÃ³ local na porta `8545`, espelhando o estado da Polygon. **Mantenha este terminal aberto.**

# 3. Ciclo de Vida do Contrato

Com o ambiente configurado e o Anvil rodando, vocÃª pode compilar, testar e implantar o contrato.

### CompilaÃ§Ã£o
Compile os contratos inteligentes:
```bash
npx hardhat compile
```

### Testes
Execute a suÃ­te de testes. Os testes sÃ£o configurados para rodar no fork do Anvil, interagindo com tokens e pools reais da Uniswap.
```bash
npx hardhat test
```
Os testes cobrem:
- Funcionalidades de `onlyOwner`.
- GestÃ£o de stablecoins (adicionar/remover).
- LÃ³gica de swap na Uniswap V3, incluindo a busca dinÃ¢mica da `feeTier` via The Graph.
- Falhas esperadas, como tentativas de swap com tokens nÃ£o aprovados.

### Cobertura de Testes
Para gerar um relatÃ³rio de cobertura de cÃ³digo:
```bash
npx hardhat coverage
```
Isso criarÃ¡ uma pasta `coverage/` com um relatÃ³rio detalhado em HTML.

### ImplantaÃ§Ã£o (Deploy)
Para implantar os contratos no seu fork local do Anvil:
```bash
npx hardhat run scripts/deploy.js --network localhost
```
Este script irÃ¡:
1.  Implantar um contrato `Token` de exemplo (ERC-20).
2.  Implantar o contrato `SplitPayment`.
3.  Salvar os endereÃ§os dos contratos implantados no arquivo `contract-addresses.json` para fÃ¡cil acesso por outros scripts.

# 4. Interagindo com o Contrato

ApÃ³s a implantaÃ§Ã£o, vocÃª pode interagir com o contrato usando o script `interact.js` ou o console do Hardhat.

### Usando o Script de InteraÃ§Ã£o
O script `scripts/interact.js` demonstra como usar as funcionalidades do `SplitPayment`, como adicionar uma stablecoin e executar um swap.

Execute o script:
```bash
npx hardhat run scripts/interact.js --network localhost
```
O script usa os endereÃ§os do `contract-addresses.json` e executa as seguintes aÃ§Ãµes:
1.  Adiciona o BRZ como uma stablecoin.
2.  Aprova o contrato `SplitPayment` para gastar o token de teste.
3.  Executa um swap do token de teste para BRZ.
4.  Verifica os saldos antes e depois do swap.

### Usando o Console do Hardhat
Para uma interaÃ§Ã£o mais manual e exploratÃ³ria:
```bash
npx hardhat console --network localhost
```
Dentro do console, vocÃª pode instanciar e chamar as funÃ§Ãµes do contrato:
```javascript
// Obter o endereÃ§o do contrato do arquivo gerado
const addresses = require("./contract-addresses.json");
const splitPaymentAddress = addresses.splitPayment;

// Anexar ao contrato implantado
const SplitPayment = await ethers.getContractFactory("SplitPayment");
const splitPayment = await SplitPayment.attach(splitPaymentAddress);

// Exemplo: verificar a carteira de imposto
await splitPayment.taxWallet();

// Exemplo: verificar se um token Ã© stablecoin
const BRZ_ADDRESS = "0x4fAD614A7b5533E7245b7333513c19b06794348F";
await splitPayment.isStablecoin(BRZ_ADDRESS);
```
# 5. AnÃ¡lise de SeguranÃ§a com Mythril

Mythril Ã© uma poderosa ferramenta para anÃ¡lise estÃ¡tica e simbÃ³lica de seguranÃ§a. Para usÃ¡-la, Ã© recomendado ter um ambiente Python.

### ConfiguraÃ§Ã£o do Ambiente Python
```bash
# Crie um ambiente virtual (recomendado)
python3 -m venv venv
source venv/bin/activate

# Instale o Mythril
pip install mythril
```

### Executando a AnÃ¡lise
Para analisar o contrato `SplitPayment.sol` e detectar vulnerabilidades comuns, execute:
```bash
myth analyze contracts/SplitPayment.sol --solc-json solc-json.json -o markdown > mythril_analysis.md
```
- `solc-json.json`: Este arquivo mapeia os imports do OpenZeppelin para que o Mythril possa encontrÃ¡-los.
- `-o markdown`: Formata a saÃ­da em Markdown.
- `> mythil_analysis.md`: Salva o relatÃ³rio no arquivo `mythil_analysis.md`.

# 6. Estrutura do Projeto

```
piloto/
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ SplitPayment.sol  # O contrato principal
â”‚   â””â”€â”€ Token.sol         # Um contrato ERC-20 de exemplo
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy.js         # Script para implantar os contratos
â”‚   â””â”€â”€ interact.js       # Script para interagir com o contrato implantado
â”œâ”€â”€ test/
â”‚   â””â”€â”€ SplitPayment.test.js # Testes para o contrato
â”œâ”€â”€ hardhat.config.js     # ConfiguraÃ§Ã£o do Hardhat (redes, compilador)
â”œâ”€â”€ contract-addresses.json # Gerado pelo deploy.js com os endereÃ§os
â”œâ”€â”€ .env                  # VariÃ¡veis de ambiente (nÃ£o versionado)
â””â”€â”€ README.md             # Este arquivo
```
